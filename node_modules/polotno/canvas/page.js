"use strict";var __assign=this&&this.__assign||function(){return(__assign=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)},__rest=this&&this.__rest||function(e,t){var r={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(r[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(n=Object.getOwnPropertySymbols(e);o<n.length;o++)t.indexOf(n[o])<0&&Object.prototype.propertyIsEnumerable.call(e,n[o])&&(r[n[o]]=e[n[o]])}return r},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.registerTransformerAttrs=void 0;var react_1=__importDefault(require("react")),mobx_react_lite_1=require("mobx-react-lite"),mobx_1=require("mobx"),react_konva_1=require("react-konva"),use_image_1=__importDefault(require("use-image")),konva_1=__importDefault(require("konva")),element_1=__importDefault(require("./element")),crop_1=require("../utils/crop"),DEFAULT_TRANSFORMER_ATTRIBUTES={enabledAnchors:["top-left","top-center","top-right","middle-left","bottom-left","bottom-right","bottom-center","middle-right"],rotateEnabled:!0,rotationSnaps:[0,45,90,135,180,225,270,315],ignoreStroke:!0},transformerAttributes={text:{enabledAnchors:["top-left","top-right","middle-left","bottom-left","bottom-right","middle-right"]},svg:{enabledAnchors:["top-left","top-right","bottom-left","bottom-right"]},many:{enabledAnchors:["top-left","top-right","bottom-left","bottom-right"]}};function registerTransformerAttrs(e,t){transformerAttributes[e]=transformerAttributes[e]||t,Object.assign(transformerAttributes[e],t)}exports.registerTransformerAttrs=registerTransformerAttrs;var Background=function(e){return react_1.default.createElement(react_konva_1.Rect,__assign({},e,{fill:"#e8e8e8"}))},PageBackground=function(e){var t=e.background,r=__rest(e,["background"]),n=t.indexOf("http")>=0||t.indexOf(".png")>=0||t.indexOf(".jpg")>=0,o=use_image_1.default(n?t:"","Anonymous")[0],a=n?react_konva_1.Image:react_konva_1.Rect,i=n&&o?crop_1.getCrop(o,{width:e.width,height:e.height},"center-middle"):{};return react_1.default.createElement(react_1.default.Fragment,null,react_1.default.createElement(react_konva_1.Rect,{x:-1,y:-1,width:e.width+2,height:e.height+2,stroke:"lightgrey",strokeWidth:2,listening:!1}),react_1.default.createElement(a,__assign({image:o},r,{fill:n?"white":t},i)))},Selection=mobx_react_lite_1.observer((function(e){var t=e.selection;return t.visible?react_1.default.createElement(react_konva_1.Rect,{name:"selection",x:Math.min(t.x1,t.x2),y:Math.min(t.y1,t.y2),width:Math.abs(t.x1-t.x2),height:Math.abs(t.y1-t.y2),fill:"rgba(0, 161, 255, 0.3)"}):null}));exports.default=mobx_react_lite_1.observer((function(e){var t=e.store,r=e.page,n=e.xPadding,o=e.yPadding,a=e.width,i=e.height,c=react_1.default.useRef(null);react_1.default.useEffect((function(){var e=mobx_1.autorun((function(){var e,r;if(c.current){var n=c.current.getStage(),o=t.selectedElements.map((function(e){return e._cropModeEnabled?null:n.findOne("#"+e.id)})).filter((function(e){return e})),a=t.selectedElements.filter((function(e){return e.locked})).length>0,i=1===t.selectedElements.length,l=i&&(null===(e=t.selectedElements[0])||void 0===e?void 0:e.type)||"many";a?(c.current.enabledAnchors([]),c.current.rotateEnabled(!1)):i&&transformerAttributes[l]?c.current.setAttrs(__assign(__assign({},DEFAULT_TRANSFORMER_ATTRIBUTES),transformerAttributes[l])):c.current.setAttrs(DEFAULT_TRANSFORMER_ATTRIBUTES),c.current.nodes(o),null===(r=c.current.getLayer())||void 0===r||r.batchDraw()}}),{delay:50});return function(){return e()}}),[]);var l=react_1.default.useRef(),u=mobx_react_lite_1.useLocalObservable((function(){return{visible:!1,x1:0,y1:0,x2:0,y2:0}})),s=react_1.default.useRef(!1),d=mobx_1.action((function(e){var n;s.current=!1,t.activePage!==r&&r.select();var o=e.target.findAncestor(".elements-container"),a=e.target.findAncestor("Transformer"),i=e.target.findAncestor(".page-abs-container");if(!(o||a||i)){var c=null===(n=e.target.getStage())||void 0===n?void 0:n.getPointerPosition();u.visible=!0,u.x1=c.x,u.y1=c.y,u.x2=c.x,u.y2=c.y}}));react_1.default.useEffect((function(){var e=mobx_1.action((function(e){var t,r;if(u.visible){null===(t=l.current)||void 0===t||t.setPointersPositions(e);var n=(null===(r=l.current)||void 0===r?void 0:r.getPointerPosition())||{x:u.x2,y:u.y2};u.x2=n.x,u.y2=n.y}})),r=mobx_1.action((function(){if(u.visible&&l.current){var e=l.current.findOne(".selection").getClientRect(),r=[];l.current.find(".element").toArray().forEach((function(t){var n=t.getClientRect();konva_1.default.Util.haveIntersection(e,n)&&r.push(t.id())})),t.selectElements(r),u.visible=!1,s.current=!0}}));return window.addEventListener("mousemove",e),window.addEventListener("touchmove",e),window.addEventListener("mouseup",r),window.addEventListener("touchend",r),function(){window.removeEventListener("mousemove",e),window.removeEventListener("touchmove",e),window.removeEventListener("mouseup",r),window.removeEventListener("touchend",r)}}),[]);var f=function(e){if(!s.current){var r=!e.target.findAncestor(".elements-container"),n=e.target.findAncestor("Transformer");r&&!n&&t.selectElements([])}};return react_1.default.createElement("div",{onDragOver:function(e){return e.preventDefault()},onDrop:function(e){var t;e.preventDefault(),l.current.setPointersPositions(e);var r=null===(t=l.current)||void 0===t?void 0:t.findOne(".elements-container"),n=r.getAbsoluteTransform().copy();n.invert();var o=r.getStage().getPointerPosition(),a=n.point(o);window.__polotnoDrop&&window.__polotnoDrop(a)}},react_1.default.createElement(react_konva_1.Stage,{ref:l,width:a,height:i,onClick:f,onTap:f,onMouseDown:d,onTouchStart:d,pageId:r.id},react_1.default.createElement(react_konva_1.Layer,null,react_1.default.createElement(Background,{width:a,height:i}),react_1.default.createElement(react_konva_1.Group,{x:n,y:o,scaleX:t.scale,scaleY:t.scale,name:"page-container"},react_1.default.createElement(PageBackground,{width:t.width,height:t.height,background:r.background,shadowBlur:10,shadowColor:"lightgrey",name:"page-background"}),react_1.default.createElement(react_konva_1.Group,{clipX:0,clipY:0,clipWidth:t.width,clipHeight:t.height,name:"elements-container"},r.children.map((function(e){return react_1.default.createElement(element_1.default,{key:e.id,store:t,element:e,onClick:function(){t.selectElements([e.id])}})})))),react_1.default.createElement(react_konva_1.Group,{x:n,y:o,scaleX:t.scale,scaleY:t.scale,name:"page-abs-container"},react_1.default.createElement(react_konva_1.Transformer,{ref:c,boundBoxFunc:function(e,t){var r=t.width<1||t.height<1,n=e.width<1||e.height<1;return r&&!n?e:t}})),react_1.default.createElement(Selection,{selection:u}),t._showCredit&&react_1.default.createElement(react_konva_1.Text,{text:"Powered by polotno.dev",fontSize:14,fill:"rgba(0,0,0,0.6)",x:a-156,y:i-18,onMouseEnter:function(e){e.target.getStage().container().style.cursor="pointer"},onMouseLeave:function(e){e.target.getStage().container().style.cursor=""},onTouchStart:function(e){e.cancelBubble=!0},onMouseDown:function(e){e.cancelBubble=!0},onClick:function(){window.open("https://polotno.dev")},onTap:function(){window.open("https://polotno.dev")}}))))}));