"use strict";var __importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ImageElement=void 0;var react_1=__importDefault(require("react")),mobx_react_lite_1=require("mobx-react-lite"),mobx_1=require("mobx"),react_konva_1=require("react-konva"),use_image_1=__importDefault(require("use-image")),use_snap_1=require("./use-snap"),portal_1=require("../react-konva-utils/portal"),apply_filters_1=require("./apply-filters"),use_fadein_1=require("./use-fadein"),useFlip=function(t,e){return react_1.default.useMemo((function(){var r,a,o=t.flipX,n=t.flipY;if(!o&&!n)return e;if(!e)return null;var i=document.createElement("canvas"),c=1;"svg"===t.type&&(c=Math.max(t.width/e.width,t.height/e.height)),i.width=e.width*c||1,i.height=e.height*c||1;var l=o?-i.width:0,d=n?-i.height:0;return null===(r=i.getContext("2d"))||void 0===r||r.scale(o?-1:1,n?-1:1),null===(a=i.getContext("2d"))||void 0===a||a.drawImage(e,l,d,i.width,i.height),i}),[t.flipX,t.flipY,e,t.width,t.height])},loaderCanvas=document.createElement("canvas");loaderCanvas.width=800,loaderCanvas.height=600;var loaderCtx=loaderCanvas.getContext("2d");null==loaderCtx||(loaderCtx.fillStyle="#E5F0F9"),null==loaderCtx||loaderCtx.fillRect(0,0,loaderCanvas.width,loaderCanvas.height),null==loaderCtx||(loaderCtx.textAlign="center"),null==loaderCtx||(loaderCtx.fillStyle="white"),null==loaderCtx||(loaderCtx.font="30px Arial"),null==loaderCtx||loaderCtx.fillText("LOADING....",loaderCanvas.width/2,280),exports.ImageElement=mobx_react_lite_1.observer((function(t){var e=t.onClick,r=t.element,a=t.store,o=react_1.default.useState(!1),n=o[0],i=o[1],c=react_1.default.useRef(null),l=react_1.default.useRef(null),d=use_image_1.default(r.__finalSrc||r.src,"Anonymous")[0],u=react_1.default.useRef();react_1.default.useEffect((function(){u.current=d||u.current}),[d]);var h=useFlip(r,d||u.current)||loaderCanvas;react_1.default.useEffect((function(){var t;n?null===(t=c.current)||void 0===t||t.clearCache():apply_filters_1.applyFilter(c.current,r)}),[n]),react_1.default.useEffect((function(){apply_filters_1.applyFilter(c.current,r)}),[r.shadowEnabled,r.shadowBlur]);var g,s,f=h.width*r.cropWidth,p=h.height*r.cropHeight,_=r.width/r.height;_>=f/p?(g=f,s=f/_):(g=p*_,s=p),react_1.default.useLayoutEffect((function(){if(!n)return apply_filters_1.applyFilter(c.current,r),mobx_1.autorun((function(){apply_filters_1.applyFilter(c.current,r)}),{delay:100})}),[h,n,g,s]);var m=use_snap_1.useSnap(c),x=m.onDragMove,v=m.onDragEnd;use_fadein_1.useFadeIn(c);var y=Math.max(r.width/g,r.height/s);react_1.default.useEffect((function(){var t;if(r._cropModeEnabled){var e=null===(t=c.current)||void 0===t?void 0:t.getStage();return document.body.addEventListener("click",o),null==e||e.on("click",a),function(){document.body.removeEventListener("click",o),null==e||e.off("click",a)}}function a(t){r._cropModeEnabled&&t.target!==l.current&&r.toggleCropMode(!1)}function o(t){r._cropModeEnabled&&"CANVAS"!==t.target.nodeName&&r.toggleCropMode(!1)}}),[r._cropModeEnabled]);var w=react_1.default.useRef(null),E=react_1.default.useRef(null),b=react_1.default.useRef(null);react_1.default.useLayoutEffect((function(){r._cropModeEnabled&&(E.current.nodes([w.current]),E.current.rotation(r.rotation),E.current.forceUpdate(),b.current.nodes([l.current]),b.current.rotation(r.rotation),b.current.forceUpdate())}),[r._cropModeEnabled]),react_1.default.useLayoutEffect((function(){r._cropModeEnabled&&(E.current.rotation(r.rotation),E.current.forceUpdate(),b.current.rotation(r.rotation),b.current.forceUpdate())}),[r._cropModeEnabled,r.cropX,r.cropY,r.cropWidth,r.cropHeight]);var M=function(t){Math.round(t.target.x())>0&&(t.target.x(0),t.target.scaleX(1)),Math.round(t.target.y())>0&&(t.target.y(0),t.target.scaleY(1));var e=t.target.width()*t.target.scaleX(),a=t.target.height()*t.target.scaleY(),o=Math.min(1,g/e),n=Math.min(1,s/a),i=1-o,c=Math.min(i,Math.max(0,Math.round(-t.target.x())/e)),l=1-n,d=Math.min(l,Math.max(0,Math.round(-t.target.y())/a));t.target.setAttrs({x:-c*h.width,y:-d*h.height,scaleX:1,scaleY:1}),r.set({cropX:c,cropY:d,cropWidth:o,cropHeight:n})},C=function(){"svg"!==r.type&&(r.locked||setTimeout((function(){r.toggleCropMode(!0)})))};return react_1.default.createElement(react_1.default.Fragment,null,react_1.default.createElement(react_konva_1.Image,{ref:c,name:"element",image:h,x:r.x,y:r.y,width:r.width,height:r.height,rotation:r.rotation,opacity:r.opacity,shadowEnabled:r.shadowEnabled,shadowBlur:r.shadowBlur,cropX:h.width*r.cropX,cropY:h.height*r.cropY,cropWidth:g,cropHeight:s,draggable:!r.locked,onDragStart:function(){a.selectedElements.find((function(t){return t===r}))||a.selectElements([r.id]),a.history.startTransaction()},onDragMove:x,onDragEnd:function(t){v(t),r.set({x:t.target.x(),y:t.target.y()}),a.history.endTransaction()},id:r.id,onClick:function(){e()},onTap:function(){e()},onDblClick:C,onDblTap:C,onTransformStart:function(){i(!0),a.history.startTransaction()},onTransform:function(t){var e,a=t.currentTarget,o=a.scaleX(),n=a.scaleY();a.scaleX(1),a.scaleY(1);(null===(e=t.target.getStage())||void 0===e?void 0:e.findOne("Transformer")).getActiveAnchor();var i=1-g/h.width,c=Math.min(i,Math.max(0,r.cropX)),l=1-s/h.height,d=Math.min(l,Math.max(0,r.cropY));r.set({cropX:c,cropY:d,x:a.x(),y:a.y(),width:a.width()*o,height:a.height()*n,rotation:t.target.rotation(),cropWidth:Math.min(r.cropWidth,1-c),cropHeight:Math.min(r.cropHeight,1-d)})},onTransformEnd:function(t){var e=t.currentTarget;r.set({width:e.width(),height:e.height(),x:e.x(),y:e.y(),rotation:t.target.rotation()}),i(!1),a.history.endTransaction()}}),r._cropModeEnabled&&react_1.default.createElement(portal_1.Portal,{selector:".page-abs-container",enabled:!0},react_1.default.createElement(react_konva_1.Rect,{x:-500,y:-500,width:2500,height:2500,fill:"rgba(0,0,0,0.2)"}),react_1.default.createElement(react_konva_1.Image,{listening:!1,image:h,x:r.x,y:r.y,width:r.width,height:r.height,rotation:r.rotation,shadowEnabled:r.shadowEnabled,shadowBlur:r.shadowBlur,cropX:h.width*r.cropX,cropY:h.height*r.cropY,cropWidth:g,cropHeight:s}),react_1.default.createElement(react_konva_1.Group,{x:r.x,y:r.y,rotation:r.rotation,scaleX:y,scaleY:y},react_1.default.createElement(react_konva_1.Image,{image:h,ref:l,opacity:.3,draggable:!0,x:-r.cropX*h.width,y:-r.cropY*h.height,onDragMove:M,onTransform:M}),react_1.default.createElement(react_konva_1.Transformer,{ref:b,anchorSize:20,enabledAnchors:["top-left","top-right","bottom-left","bottom-right"],boundBoxFunc:function(t,e){return e.width<5||e.height<5?t:e},rotateEnabled:!1,borderEnabled:!1,anchorCornerRadius:10}),react_1.default.createElement(react_konva_1.Rect,{width:g,height:s,ref:w,listening:!1,onTransform:function(t){t.target.x()<-r.cropX*h.width-1e-9&&(t.target.x(-r.cropX*h.width),t.target.scaleX(1)),t.target.y()<-r.cropY*h.height-1e-9&&(t.target.y(-r.cropY*h.height),t.target.scaleY(1));var e=Math.min(1,Math.max(0,r.cropX+t.target.x()/h.width)),a=Math.min(1,Math.max(0,t.target.y()/h.height+r.cropY)),o=t.target.width()*t.target.scaleX(),n=t.target.height()*t.target.scaleY(),i=Math.min(1-e,o/h.width),c=Math.min(1-a,n/h.height),l=t.target.getAbsolutePosition(t.target.getParent().getParent());t.target.scale({x:1,y:1}),t.target.position({x:0,y:0}),r.set({x:l.x,y:l.y,cropX:e,cropY:a,cropWidth:i,cropHeight:c,width:Math.min(o*y,h.width*(1-e)*y),height:Math.min(n*y,h.height*(1-a)*y)})}}),react_1.default.createElement(react_konva_1.Transformer,{ref:E,enabledAnchors:["top-left","top-right","bottom-left","bottom-right"],boundBoxFunc:function(t,e){return e.width<5||e.height<5?t:e},keepRatio:!1,rotateEnabled:!1,anchorFill:"rgb(240, 240, 240)"}))))}));