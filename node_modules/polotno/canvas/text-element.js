"use strict";var __extends=this&&this.__extends||function(){var t=function(e,r){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])})(e,r)};return function(e,r){function n(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}(),__awaiter=this&&this.__awaiter||function(t,e,r,n){return new(r||(r=Promise))((function(o,a){function i(t){try{u(n.next(t))}catch(t){a(t)}}function l(t){try{u(n.throw(t))}catch(t){a(t)}}function u(t){var e;t.done?o(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(i,l)}u((n=n.apply(t,e||[])).next())}))},__generator=this&&this.__generator||function(t,e){var r,n,o,a,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:l(0),throw:l(1),return:l(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function l(a){return function(l){return function(a){if(r)throw new TypeError("Generator is already executing.");for(;i;)try{if(r=1,n&&(o=2&a[0]?n.return:a[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,a[1])).done)return o;switch(n=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return i.label++,{value:a[1],done:!1};case 5:i.label++,n=a[1],a=[0];continue;case 7:a=i.ops.pop(),i.trys.pop();continue;default:if(!(o=i.trys,(o=o.length>0&&o[o.length-1])||6!==a[0]&&2!==a[0])){i=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){i.label=a[1];break}if(6===a[0]&&i.label<o[1]){i.label=o[1],o=a;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(a);break}o[2]&&i.ops.pop(),i.trys.pop();continue}a=e.call(t,i)}catch(t){a=[6,t],n=0}finally{r=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,l])}}},__importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.TextElement=void 0;var react_1=__importDefault(require("react")),react_dom_1=__importDefault(require("react-dom")),mobx_react_lite_1=require("mobx-react-lite"),react_konva_1=require("react-konva"),mobx_1=require("mobx"),use_snap_1=require("./use-snap"),apply_filters_1=require("./apply-filters"),use_fadein_1=require("./use-fadein"),Portal=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.prototype.componentDidMount=function(){this.renderPortal()},e.prototype.componentDidUpdate=function(t){this.renderPortal()},e.prototype.componentWillUnmount=function(){var t;react_dom_1.default.unmountComponentAtNode(this.defaultNode),null===(t=this.defaultNode)||void 0===t||t.parentNode.removeChild(this.defaultNode),this.defaultNode=null},e.prototype.renderPortal=function(t){this.defaultNode||(this.defaultNode=document.createElement("div"),this.props.node.appendChild(this.defaultNode)),react_dom_1.default.render(this.props.children,this.defaultNode)},e.prototype.render=function(){return null},e}(react_1.default.Component),TextInput=mobx_react_lite_1.observer((function(t){var e=t.textNodeRef,r=t.element,n=t.onBlur,o=t.selectAll,a=react_1.default.useState({}),i=a[0],l=a[1],u=e.current,c=u.absolutePosition(),f=u.getAbsoluteScale().x,d=c.x,s=c.y;react_1.default.useLayoutEffect((function(){var t={position:"absolute"};t.top=s+"px",t.left=d+"px",t.width=u.width()-2*u.padding()+"px",t.height=u.height()-2*u.padding()+10+"px",t.fontSize=u.fontSize()+"px",t.border="none",t.padding="0px",t.margin="0px",t.overflow="hidden",t.background="none",t.outline="none",t.resize="none",t.lineHeight=u.lineHeight()+.01,t.fontFamily='"'+u.fontFamily()+'"',t.transformOrigin="left top",t.textAlign=u.align(),t.color=u.fill(),t.transform="rotateZ("+u.rotation()+"deg) scale("+f+")",t.overflowWrap="break-word",t.whiteSpace="pre-wrap",t.userSelect="text",t.wordBreak="normal",JSON.stringify(t)!==JSON.stringify(i)&&l(t)}));var p=react_1.default.useRef(null);return react_1.default.useEffect((function(){var t,e;i.position&&(null===(t=p.current)||void 0===t||t.focus(),o&&(null===(e=p.current)||void 0===e||e.select(),document.execCommand("selectAll",!1,null)))}),[i.position]),react_1.default.useEffect((function(){p.current&&p.current.innerText!==r.text&&(p.current.innerText=r.text)}),[r.text]),react_1.default.createElement(Portal,{node:e.current&&e.current.getStage().container()},react_1.default.createElement("textarea",{ref:p,style:i,value:r.text,onChange:function(t){r.set({text:t.target.value})},placeholder:r.placeholder,onBlur:n}))})),useEditor=function(t){var e=react_1.default.useState(!1),r=e[0],n=e[1],o=react_1.default.useRef(!1);return react_1.default.useEffect((function(){var e=!0;return setTimeout((function(){e&&(t._editModeEnabled&&(o.current=!0),n(!0))}),50),function(){e=!1}}),[]),{editorEnabled:r&&t._editModeEnabled,selectAll:o.current}};exports.TextElement=mobx_react_lite_1.observer((function(t){var e=t.onClick,r=t.element,n=t.store,o=react_1.default.useRef(null),a=useEditor(r),i=a.editorEnabled,l=a.selectAll;react_1.default.useEffect((function(){if(!r.width){var t=o.current;t.width(600),r.set({width:1.4*t.getTextWidth()})}}),[]),react_1.default.useEffect((function(){var t=o.current;r.height!==t.height()&&r.set({height:t.height()})})),react_1.default.useLayoutEffect((function(){return mobx_1.autorun((function(){var t=o.current;apply_filters_1.applyFilter(t,r)}))})),react_1.default.useEffect((function(){var t=!0;function e(){var t,e=o.current;e._setTextData(),e.width(e.width()+1e-9),null===(t=e.getLayer())||void 0===t||t.batchDraw(),apply_filters_1.applyFilter(e,r)}return function(){__awaiter(this,void 0,void 0,(function(){return __generator(this,(function(o){switch(o.label){case 0:return e(),[4,n.loadFont(r.fontFamily)];case 1:return o.sent(),t?(e(),[2]):[2]}}))}))}(),function(){t=!1}}),[r.fontFamily]);var u=use_snap_1.useSnap(o),c=u.onDragMove,f=u.onDragEnd;use_fadein_1.useFadeIn(o);var d=react_1.default.useRef(null),s=function(){n.selectedElements.find((function(t){return t===r}))&&!r.locked&&r.toggleEditMode(),e()},p=!r.text&&r.placeholder,_=r._editModeEnabled?0:p?.6:r.opacity;return react_1.default.createElement(react_1.default.Fragment,null,react_1.default.createElement(react_konva_1.Text,{ref:o,name:"element",x:r.x,y:r.y,rotation:r.rotation,width:r.width,text:r.text||r.placeholder,fill:r.fill,stroke:r.stroke,strokeWidth:r.strokeWidth,fillAfterStrokeEnabled:!0,fontSize:r.fontSize,fontFamily:r.fontFamily,fontStyle:r.fontStyle,textDecoration:r.textDecoration,align:r.align,draggable:!r.locked,opacity:_,shadowEnabled:r.shadowEnabled,shadowBlur:r.shadowBlur,lineHeight:r.lineHeight,letterSpacing:r.letterSpacing*r.fontSize,onDragStart:function(){n.selectedElements.find((function(t){return t===r}))||n.selectElements([r.id]),n.history.startTransaction()},onDragMove:c,onDragEnd:function(t){f(t),r.set({x:t.target.x(),y:t.target.y()}),n.history.endTransaction()},id:r.id,onClick:s,onTap:s,onTransformStart:function(){n.history.startTransaction()},onTransform:function(t){var e,n=(null===(e=t.target.getStage())||void 0===e?void 0:e.findOne("Transformer")).getActiveAnchor();if("middle-left"===n||"middle-right"===n){var o=t.target.scaleX(),a=t.target.width()*o,i=r.fontSize,l=a;a<i&&(l=i,d.current&&t.target.position(d.current)),t.target.width(l),t.target.scaleX(1),apply_filters_1.applyFilter(t.target,r)}t.target.strokeWidth(r.strokeWidth/t.target.scaleX()),d.current=t.target.position()},onTransformEnd:function(t){var e=t.target.scaleX();t.target.scaleX(1),t.target.scaleY(1),t.target.strokeWidth(r.strokeWidth),r.set({fontSize:r.fontSize*e,width:t.target.width()*e,x:t.target.x(),y:t.target.y(),rotation:t.target.rotation()}),n.history.endTransaction()}}),i&&react_1.default.createElement(TextInput,{textNodeRef:o,element:r,selectAll:l,onBlur:function(){r.toggleEditMode(!1)}}))}));