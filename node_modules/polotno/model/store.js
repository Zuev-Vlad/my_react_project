"use strict";var __assign=this&&this.__assign||function(){return(__assign=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)},__createBinding=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&__createBinding(t,e,n);return __setModuleDefault(t,e),t},__awaiter=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function s(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((r=r.apply(e,t||[])).next())}))},__generator=this&&this.__generator||function(e,t){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(i){return function(s){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;a;)try{if(n=1,r&&(o=2&i[0]?r.return:i[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,r=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){a.label=i[1];break}if(6===i[0]&&a.label<o[1]){a.label=o[1],o=i;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(i);break}o[2]&&a.ops.pop(),a.trys.pop();continue}i=t.call(e,a)}catch(e){i=[6,e],r=0}finally{n=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,s])}}},__rest=this&&this.__rest||function(e,t){var n={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(r=Object.getOwnPropertySymbols(e);o<r.length;o++)t.indexOf(r[o])<0&&Object.prototype.propertyIsEnumerable.call(e,r[o])&&(n[r[o]]=e[r[o]])}return n},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.createStore=exports.Store=exports.Font=exports.Page=exports.registerShapeModel=exports.SVGElement=exports.ImageElement=exports.TextElement=exports.Element=void 0;var mobx_state_tree_1=require("mobx-state-tree"),undo_manager_1=require("./undo-manager"),nanoid_1=require("nanoid"),konva_1=__importDefault(require("konva")),download_1=require("../utils/download"),pdf_1=require("../utils/pdf"),validate_key_1=require("../utils/validate-key"),fonts=__importStar(require("../utils/fonts")),svg_1=require("../utils/svg");exports.Element=mobx_state_tree_1.types.model("Element",{id:mobx_state_tree_1.types.identifier,type:"none",x:0,y:0,rotation:0,opacity:1,locked:!1,blurEnabled:!1,blurRadius:10,brightnessEnabled:!1,brightness:0,sepiaEnabled:!1,grayscaleEnabled:!1,shadowEnabled:!1,shadowBlur:5,shadowOffsetX:0,shadowOffsetY:0,shadowColor:"black",custom:mobx_state_tree_1.types.frozen()}).postProcessSnapshot((function(e){var t=__assign({},e),n={};for(var r in t)"_"!==r[0]&&(n[r]=e[r]);return n})).views((function(e){return{get page(){return mobx_state_tree_1.getParentOfType(e,exports.Page)},get store(){return mobx_state_tree_1.getParentOfType(e,exports.Store)}}})).actions((function(e){return{toJSON:function(){return __assign({},mobx_state_tree_1.getSnapshot(e))},clone:function(t){var n=e.toJSON();t.id=t.id||nanoid_1.nanoid(10),Object.assign(n,t),e.page.addElement(n)},set:function(t){Object.assign(e,t)},moveUp:function(){e.page.moveElementUp(e.id)},moveTop:function(){e.page.moveElementTop(e.id)},moveDown:function(){e.page.moveElementDown(e.id)},moveBottom:function(){e.page.moveElementBottom(e.id)},beforeDestroy:function(){e.store.history.endTransaction()}}})),exports.TextElement=exports.Element.named("Text").props({type:"text",text:"",placeholder:"",fontSize:14,fontFamily:"Roboto",fontStyle:"",textDecoration:"",fill:"black",align:"center",width:100,height:14,strokeWidth:0,stroke:"black",lineHeight:1,letterSpacing:0,_editModeEnabled:!1}).actions((function(e){return{toggleEditMode:function(t){e._editModeEnabled=null!=t?t:!e._editModeEnabled,e._editModeEnabled?e.store.history.startTransaction():e.store.history.endTransaction()}}})),exports.ImageElement=exports.Element.named("Image").props({type:"image",width:100,height:100,src:"",cropX:0,cropY:0,cropWidth:1,cropHeight:1,flipX:!1,flipY:!1,_cropModeEnabled:!1}).actions((function(e){return{toggleCropMode:function(t){e._cropModeEnabled=null!=t?t:!e._cropModeEnabled,e._cropModeEnabled?e.store.history.startTransaction():e.store.history.endTransaction()}}})),exports.SVGElement=exports.Element.named("SVG").props({type:"svg",src:"",__svgString:"",cropX:0,cropY:0,cropWidth:1,cropHeight:1,flipX:!1,flipY:!1,width:100,height:100,colorsReplace:mobx_state_tree_1.types.map(mobx_state_tree_1.types.string)}).preProcessSnapshot((function(e){return __assign(__assign({},e),{src:e.src||e.svgSource})})).views((function(e){return{get colors(){return e.__svgString?svg_1.getColors(e.__svgString):[]},get __finalSrc(){return e.__svgString?svg_1.replaceColors(svg_1.fixSize(e.__svgString),e.colorsReplace):this.src}}})).actions((function(e){return{set:function(t){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(n){switch(n.label){case 0:return Object.assign(e,t),t.src?[4,e._loadSVG()]:[3,2];case 1:n.sent(),n.label=2;case 2:return[2]}}))}))},_loadSVG:function(){return __awaiter(this,void 0,void 0,(function(){var t;return __generator(this,(function(n){switch(n.label){case 0:return e.src?[4,svg_1.urlToString(e.src)]:[2];case 1:return t=n.sent(),e.store.history.ignore((function(){e.set({__svgString:t})})),[2]}}))}))},afterCreate:function(){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(t){return e._loadSVG(),[2]}))}))},replaceColor:function(t,n){e.colorsReplace.set(t,n)}}}));var TYPES_MAP={svg:exports.SVGElement,text:exports.TextElement,image:exports.ImageElement},ADDITIONAL_TYPES=[];function registerShapeModel(e){var t=e.type;if(!t)throw new Error('You must pass "type" attribute to custom model.');var n=exports.Element.named(t).props(e);TYPES_MAP[t]=n,ADDITIONAL_TYPES.push(n)}exports.registerShapeModel=registerShapeModel;var ElementTypes=mobx_state_tree_1.types.union({dispatcher:function(e){return TYPES_MAP[e.type]}},exports.SVGElement,exports.TextElement,exports.ImageElement,mobx_state_tree_1.types.late((function(){return ADDITIONAL_TYPES[0]})),mobx_state_tree_1.types.late((function(){return ADDITIONAL_TYPES[1]}))),ChildrenType=mobx_state_tree_1.types.array(ElementTypes);function createStore(e){var t=void 0===e?{key:"",showCredit:!1}:e,n=t.key,r=t.showCredit,o=exports.Store.create();return o.__checkKey(n,r),o}exports.Page=mobx_state_tree_1.types.model("Page",{id:mobx_state_tree_1.types.identifier,children:ChildrenType,background:"white",custom:mobx_state_tree_1.types.frozen()}).views((function(e){return{get store(){return mobx_state_tree_1.getParentOfType(e,exports.Store)}}})).actions((function(e){return{toJSON:function(){return __assign({},mobx_state_tree_1.getSnapshot(e))},clone:function(t){var n=e.children.map((function(e){var t=e.toJSON();return t.id=nanoid_1.nanoid(10),t})),r=__assign({id:nanoid_1.nanoid(10),children:n,background:e.background},t);e.store.addPage(r)},set:function(t){Object.assign(e,t)},select:function(){e.store.selectPage(e.id)},addElement:function(t){var n=TYPES_MAP[t.type];if(n){var r=n.create(__assign({id:nanoid_1.nanoid(10)},t));return e.children.push(r),e.store.selectElements([r.id]),r}console.error("Can not find model with type "+t.type)},moveElementUp:function(t){var n=e.children.findIndex((function(e){return e.id===t})),r=e.children[n];mobx_state_tree_1.detach(r),e.children.remove(r),e.children.splice(n+1,0,r)},moveElementDown:function(t){var n=e.children.findIndex((function(e){return e.id===t})),r=e.children[n];mobx_state_tree_1.detach(r),e.children.remove(r),e.children.splice(n-1,0,r)},moveElementTop:function(t){var n=e.children.findIndex((function(e){return e.id===t})),r=e.children[n];mobx_state_tree_1.detach(r),e.children.remove(r),e.children.push(r)},moveElementBottom:function(t){var n=e.children.findIndex((function(e){return e.id===t})),r=e.children[n];mobx_state_tree_1.detach(r),e.children.remove(r),e.children.splice(0,0,r)}}})),exports.Font=mobx_state_tree_1.types.model("Font",{name:mobx_state_tree_1.types.string,url:mobx_state_tree_1.types.string}),exports.Store=mobx_state_tree_1.types.model("Store",{pages:mobx_state_tree_1.types.array(exports.Page),fonts:mobx_state_tree_1.types.array(exports.Font),width:1080,height:1080,scale:1,selectedElementsIds:mobx_state_tree_1.types.array(mobx_state_tree_1.types.string),history:mobx_state_tree_1.types.optional(undo_manager_1.UndoManager,{targetPath:"../pages"}),_showCredit:!1,_activePageId:""}).views((function(e){return{get selectedElements(){return e.selectedElementsIds.map((function(t){for(var n=0,r=e.pages;n<r.length;n++)for(var o=0,i=r[n].children;o<i.length;o++){var a=i[o];if(a.id===t)return a}})).filter((function(e){return!!e}))},get activePage(){return e.pages.slice().find((function(t){return t.id===e._activePageId}))||e.pages[0]}}})).actions((function(e){return{__checkKey:function(t,n){return __awaiter(this,void 0,void 0,(function(){var r;return __generator(this,(function(o){switch(o.label){case 0:return[4,validate_key_1.validateKey(t)];case 1:return r=o.sent(),e.__(r,n),[2]}}))}))},__:function(t,n){e._showCredit=!t||n},addPage:function(t){var n=exports.Page.create(__assign({id:nanoid_1.nanoid(10)},t));return e.pages.push(n),e._activePageId=n.id,n},selectPage:function(t){e._activePageId=t},selectElements:function(t){e.selectedElementsIds=mobx_state_tree_1.cast(t)},setScale:function(t){e.scale=t},setSize:function(t,n){e.width=t,e.height=n},deletePages:function(t){t.forEach((function(t){var n=e.pages.findIndex((function(e){return e.id===t}));e.pages.splice(n,1)}))},deleteElements:function(t){t.forEach((function(t){e.pages.forEach((function(e){var n=e.children.findIndex((function(e){return e.id===t}));-1!==n&&e.children.splice(n,1)}))})),e.selectedElementsIds=mobx_state_tree_1.cast([])},on:function(t,n){if("change"===t)return mobx_state_tree_1.onSnapshot(e,(function(e){n(e)}))},toDataURL:function(t){var n=void 0===t?{}:t,r=n.pixelRatio,o=n.ignoreBackground,i=n.pageId,a=r||1,s=konva_1.default.stages.find((function(e){return e.getAttr("pageId")===i}))||konva_1.default.stages[0],c=s.findOne(".page-container");s.find("Transformer").each((function(e){return e.visible(!1)})),c.findOne(".page-background").shadowEnabled(!1),c.findOne(".page-background").strokeEnabled(!1),o&&c.findOne(".page-background").hide();var l=c.toDataURL({x:c.x(),y:c.y(),width:e.width*c.scaleX(),height:e.height*c.scaleY(),pixelRatio:1/c.scaleX()*a});return o&&c.findOne(".page-background").show(),c.findOne(".page-background").shadowEnabled(!0),c.findOne(".page-background").strokeEnabled(!0),s.find("Transformer").each((function(e){return e.visible(!0)})),l},saveAsImage:function(t){void 0===t&&(t={});var n=t.fileName,r=__rest(t,["fileName"]);download_1.downloadFile(e.toDataURL(r),n||"polotno.png","image/png")},saveAsPDF:function(t){void 0===t&&(t={});var n=t.fileName,r=__rest(t,["fileName"]);return __awaiter(this,void 0,void 0,(function(){var t,o,i,a;return __generator(this,(function(s){switch(s.label){case 0:return[4,pdf_1.getJsPDF()];case 1:return t=s.sent(),o=new t({unit:"px",orientation:e.width>e.height?"landscape":"portrait",format:[e.width,e.height]}),i=o.internal.pageSize.getWidth(),a=o.internal.pageSize.getHeight(),o.addImage(e.toDataURL(r),0,0,i,a),o.save(n||"polotno.pdf"),[2]}}))}))},toJSON:function(){return{width:e.width,height:e.height,fonts:mobx_state_tree_1.getSnapshot(e.fonts),pages:mobx_state_tree_1.getSnapshot(e.pages)}},loadJSON:function(t){var n;e.pages.forEach((function(e){return e.children.forEach((function(e){return mobx_state_tree_1.detach(e)}))})),e.pages=mobx_state_tree_1.cast([]),t._activePageId=null===(n=t.pages[0])||void 0===n?void 0:n.id,t.scale=e.scale,t._isKeyValid=e._isKeyValid,mobx_state_tree_1.applySnapshot(e,t)},addFont:function(t){e.fonts.push(t)},removeFont:function(t){var n=e.fonts.findIndex((function(e){return e.name===t}));e.fonts.splice(n,1)},loadFont:function(t){return __awaiter(this,void 0,void 0,(function(){var n;return __generator(this,(function(r){switch(r.label){case 0:return(n=e.fonts.find((function(e){return e.name===t})))?fonts.injectCustomFont(n):fonts.injectGoogleFont(t),[4,fonts.loadFont(t)];case 1:return r.sent(),[2]}}))}))}}})),exports.createStore=createStore,exports.default=createStore;